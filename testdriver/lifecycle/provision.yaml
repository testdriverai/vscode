version: 6.0.0
steps:
  - prompt: download and install vscode
    commands:
      - command: exec
        lang: pwsh
        timeout: 240000
        code: |
          # Set download URL and destination
          $installerUrl = "https://code.visualstudio.com/sha/download?build=stable&os=win32-x64-user"

          Write-Host "Downloading VS Code installer..."
          Invoke-WebRequest -Uri $installerUrl -OutFile C:\Users\testdriver\Desktop\VSCodeSetup.exe

          if (Test-Path C:\Users\testdriver\Desktop\VSCodeSetup.exe) {
              Write-Host "Download complete. Starting installation..."

              # Silent install VS Code (per user)
              Start-Process "cmd.exe" -ArgumentList "/c", "C:\Users\testdriver\Desktop\VSCodeSetup.exe /verysilent /norestart /nolaunch" -WindowStyle Hidden

              Write-Host "Installation complete."

              Write-Host "VS Code installation completed successfully."
          } else {
              Write-Host "Failed to download the installer."
              exit 1
          }

          Write-Host "Script completed successfully."
          exit 0

  - prompt: download testdriver vsix
    commands:
      - command: exec
        lang: pwsh
        timeout: 120000
        code: |
          # Set download URL and destination for VSIX
          $vsixUrl = "https://github.com/testdriverai/vscode/releases/download/v0.6.28/testdriver.vsix"
          $vsixPath = "$env:USERPROFILE\Desktop\testdriver.vsix"

          Write-Host "Downloading TestDriver VSIX..."
          Invoke-WebRequest -Uri $vsixUrl -OutFile $vsixPath

          if (Test-Path $vsixPath) {
              Write-Host "VSIX download complete."
          } else {
              Write-Host "Failed to download the VSIX file."
              exit 1
          }

          Write-Host "VSIX download completed successfully."
          exit 0
  - prompt: install testdriver extension and launch vscode
    commands:
      - command: wait
        timeout: 3000
      - command: exec
        lang: pwsh
        timeout: 120000
        code: |
          # First, install the extension
          Write-Host "Installing TestDriver extension..."
          $installResult = Start-Process "C:\Users\testdriver\AppData\Local\Programs\Microsoft VS Code\bin\code.cmd" -ArgumentList "--install-extension", "C:\Users\testdriver\Desktop\testdriver.vsix" -Wait -PassThru

          if ($installResult.ExitCode -eq 0) {
              Write-Host "Extension installed successfully."
          } else {
              Write-Host "Failed to install extension. Exit code: $($installResult.ExitCode)"
              exit 1
          }

          Write-Host "Script completed successfully."
          exit 0
